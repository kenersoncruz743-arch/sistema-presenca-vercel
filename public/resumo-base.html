<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumo Base - Análise de Presença</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-secondary { background: #6c757d; color: white; }
        
        .filtros {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .filtros h3 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }
        
        .filtro-row {
            display: grid;
            grid-template-columns: 250px 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filtro-group label {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filtro-group input, .filtro-group select {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .filtro-group select[multiple] {
            min-height: 140px;
            background: #f8f9fa;
        }
        
        .filtro-group select[multiple] option {
            padding: 8px 10px;
            border-radius: 4px;
            margin: 2px 0;
        }
        
        .filtro-group select[multiple] option:checked {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        
        .filtro-group input:focus, .filtro-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filtro-hint {
            font-size: 11px;
            color: #6c757d;
            font-style: italic;
            margin-top: 3px;
        }
        
        .filtros-ativos {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            min-height: 30px;
        }
        
        .filtro-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.3s;
        }
        
        .filtro-tag i {
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .filtro-tag i:hover {
            opacity: 1;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .resumo-geral {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card-resumo {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .card-resumo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .card-resumo h3 {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-resumo .valor {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .card-resumo .percentual {
            font-size: 16px;
            color: #28a745;
            font-weight: 600;
        }
        
        .card-resumo.warning .valor { color: #ffc107; }
        .card-resumo.danger .valor { color: #dc3545; }
        .card-resumo.success .valor { color: #28a745; }
        
        .secao {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .secao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .secao-header h2 {
            color: #667eea;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-primary { background: #e3f2fd; color: #1976d2; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        
        .tabela-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        tbody tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        .colab-toggle {
            cursor: pointer;
            color: #667eea;
            font-size: 12px;
            text-decoration: underline;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .colab-toggle:hover {
            color: #5a6fd8;
        }
        
        .colaboradores-lista {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .colaboradores-lista.show {
            display: block;
        }
        
        .colaborador-item {
            padding: 6px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .colaborador-item:last-child {
            border-bottom: none;
        }
        
        .loading {
            text-align: center;
            padding: 80px 20px;
            color: white;
        }
        
        .loading i {
            font-size: 64px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-info { background: #d1ecf1; color: #0c5460; }
        
        .barra-progresso {
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .barra-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .filtro-row {
                grid-template-columns: 1fr;
            }
            
            .resumo-geral {
                grid-template-columns: repeat(2, 1fr);
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-chart-pie"></i>
                Resumo Base - Análise de Presença
            </h1>
            <div class="header-actions">
                <button class="btn btn-success" onclick="carregarResumo()">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button class="btn btn-info" onclick="exportarResumo()">
                    <i class="fas fa-file-excel"></i> Exportar
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='/ferramentas'">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </div>

        <div class="filtros">
            <h3><i class="fas fa-filter"></i> Filtros Gerenciais</h3>
            
            <div class="filtros-ativos" id="filtrosAtivos"></div>
            
            <div class="filtro-row">
                <div class="filtro-group">
                    <label><i class="fas fa-calendar-alt"></i> Data de Referência</label>
                    <input type="date" id="filtroData" value="">
                </div>
                <div class="filtro-group">
                    <label><i class="fas fa-user-tie"></i> Supervisores</label>
                    <select id="filtroSupervisor" multiple>
                        <option value="">Carregando...</option>
                    </select>
                    <span class="filtro-hint">Segure Ctrl para selecionar múltiplos</span>
                </div>
                <div class="filtro-group">
                    <label><i class="fas fa-briefcase"></i> Funções</label>
                    <select id="filtroFuncao" multiple>
                        <option value="">Carregando...</option>
                    </select>
                    <span class="filtro-hint">Segure Ctrl para selecionar múltiplos</span>
                </div>
                <div class="filtro-group">
                    <label><i class="fas fa-clock"></i> Turnos</label>
                    <select id="filtroTurno" multiple>
                        <option value="">Carregando...</option>
                    </select>
                    <span class="filtro-hint">Segure Ctrl para selecionar múltiplos</span>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="aplicarFiltros()">
                    <i class="fas fa-search"></i> Aplicar Filtros
                </button>
                <button class="btn btn-secondary" onclick="limparFiltros()">
                    <i class="fas fa-eraser"></i> Limpar Todos
                </button>
                <button class="btn btn-info" onclick="carregarResumo()">
                    <i class="fas fa-sync-alt"></i> Recarregar Dados
                </button>
            </div>
        </div>

        <div id="statusDiv"></div>

        <div id="loadingDiv" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p style="margin-top: 20px; font-size: 18px;">Carregando resumo...</p>
        </div>

        <div id="contentDiv" style="display: none;">
            <div class="resumo-geral" id="resumoGeralCards"></div>

            <div class="secao">
                <div class="secao-header">
                    <h2><i class="fas fa-user-tie"></i> Resumo por Supervisor</h2>
                    <span class="badge badge-primary" id="totalSupervisores">0 supervisores</span>
                </div>
                <div class="tabela-container">
                    <table id="tabelaSupervisores">
                        <thead>
                            <tr>
                                <th>Supervisor</th>
                                <th>Total</th>
                                <th>Presente</th>
                                <th>Ausente</th>
                                <th>Atestado</th>
                                <th>Férias</th>
                                <th>Folga</th>
                                <th>Afastado</th>
                                <th>Desvio</th>
                                <th>Outros</th>
                                <th>Taxa Presença</th>
                                <th>Colaboradores</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="secao">
                <div class="secao-header">
                    <h2><i class="fas fa-briefcase"></i> Resumo por Função</h2>
                    <span class="badge badge-primary" id="totalFuncoes">0 funções</span>
                </div>
                <div class="tabela-container">
                    <table id="tabelaFuncoes">
                        <thead>
                            <tr>
                                <th>Função</th>
                                <th>Total</th>
                                <th>Presente</th>
                                <th>Ausente</th>
                                <th>Atestado</th>
                                <th>Férias</th>
                                <th>Folga</th>
                                <th>Afastado</th>
                                <th>Desvio</th>
                                <th>Outros</th>
                                <th>Taxa Presença</th>
                                <th>Colaboradores</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="secao">
                <div class="secao-header">
                    <h2><i class="fas fa-exclamation-triangle"></i> Detalhamento de Desvios</h2>
                    <span class="badge badge-danger" id="totalDesvios">0 desvios</span>
                </div>
                <div class="tabela-container">
                    <table id="tabelaDesvios">
                        <thead>
                            <tr>
                                <th>Colaborador</th>
                                <th>Matrícula</th>
                                <th>Função</th>
                                <th>Supervisor</th>
                                <th>Turno</th>
                                <th>Status</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dadosResumo = null;
        let dadosOriginais = null;

        function showStatus(msg, type = 'info') {
            const div = document.getElementById('statusDiv');
            const icon = type === 'success' ? 'check-circle' : 
                         type === 'error' ? 'exclamation-triangle' : 'info-circle';
            
            div.innerHTML = `
                <div class="status-message status-${type}">
                    <i class="fas fa-${icon}"></i>
                    <span>${msg}</span>
                </div>
            `;
            
            setTimeout(() => {
                div.innerHTML = '';
            }, 5000);
        }

        async function carregarResumo() {
            try {
                document.getElementById('loadingDiv').style.display = 'block';
                document.getElementById('contentDiv').style.display = 'none';

                const dataInput = document.getElementById('filtroData').value;
                
                let url = '/api/producao.js?action=resumo-base';
                if (dataInput) {
                    url += `&data=${dataInput}`;
                }

                console.log('Buscando resumo:', url);

                const response = await fetch(url);
                const result = await response.json();

                console.log('Resposta recebida:', result);

                if (!result.ok) {
                    throw new Error(result.msg || 'Erro ao carregar resumo');
                }

                dadosOriginais = JSON.parse(JSON.stringify(result));
                dadosResumo = result;
                
                preencherFiltros();
                renderResumo();

                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('contentDiv').style.display = 'block';

                showStatus(`Resumo carregado: ${dadosResumo.resumoGeral.total} colaboradores`, 'success');

            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('loadingDiv').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                    <p style="margin-top: 20px; color: #dc3545;">Erro ao carregar resumo</p>
                    <p style="font-size: 14px; color: white; margin-top: 10px;">${error.message}</p>
                    <button class="btn btn-warning" onclick="carregarResumo()" style="margin-top: 20px;">
                        <i class="fas fa-sync-alt"></i> Tentar Novamente
                    </button>
                `;
                showStatus(error.message, 'error');
            }
        }

        function preencherFiltros() {
            if (!dadosOriginais) return;

            const supervisores = [...new Set(dadosOriginais.porSupervisor.map(s => s.supervisor))].sort();
            const selectSup = document.getElementById('filtroSupervisor');
            selectSup.innerHTML = supervisores.map(s => `<option value="${s}">${s}</option>`).join('');

            const funcoes = [...new Set(dadosOriginais.porFuncao.map(f => f.funcao))].sort();
            const selectFunc = document.getElementById('filtroFuncao');
            selectFunc.innerHTML = funcoes.map(f => `<option value="${f}">${f}</option>`).join('');

            const turnos = new Set();
            dadosOriginais.porSupervisor.forEach(sup => {
                sup.colaboradores.forEach(colab => {
                    if (colab.turno && colab.turno !== 'Não informado') {
                        turnos.add(colab.turno);
                    }
                });
            });
            const turnosArray = [...turnos].sort();
            const selectTurno = document.getElementById('filtroTurno');
            selectTurno.innerHTML = turnosArray.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function aplicarFiltros() {
            if (!dadosOriginais) return;

            const supervisoresSelecionados = Array.from(document.getElementById('filtroSupervisor').selectedOptions).map(o => o.value);
            const funcoesSelecionadas = Array.from(document.getElementById('filtroFuncao').selectedOptions).map(o => o.value);
            const turnosSelecionados = Array.from(document.getElementById('filtroTurno').selectedOptions).map(o => o.value);

            console.log('Filtros aplicados:', { supervisoresSelecionados, funcoesSelecionadas, turnosSelecionados });

            atualizarTagsFiltros(supervisoresSelecionados, funcoesSelecionadas, turnosSelecionados);

            dadosResumo = JSON.parse(JSON.stringify(dadosOriginais));

            if (turnosSelecionados.length > 0) {
                dadosResumo.porSupervisor = dadosResumo.porSupervisor.map(sup => ({
                    ...sup,
                    colaboradores: sup.colaboradores.filter(c => turnosSelecionados.includes(c.turno))
                }));

                dadosResumo.porFuncao = dadosResumo.porFuncao.map(func => ({
                    ...func,
                    colaboradores: func.colaboradores.filter(c => turnosSelecionados.includes(c.turno))
                }));
            }

            if (funcoesSelecionadas.length > 0) {
                dadosResumo.porSupervisor = dadosResumo.porSupervisor.map(sup => ({
                    ...sup,
                    colaboradores: sup.colaboradores.filter(c => funcoesSelecionadas.includes(c.funcao))
                }));

                dadosResumo.porFuncao = dadosResumo.porFuncao.filter(func => 
                    funcoesSelecionadas.includes(func.funcao)
                );
            }

            if (supervisoresSelecionados.length > 0) {
                dadosResumo.porSupervisor = dadosResumo.porSupervisor.filter(sup => 
                    supervisoresSelecionados.includes(sup.supervisor)
                );

                dadosResumo.porFuncao = dadosResumo.porFuncao.map(func => ({
                    ...func,
                    colaboradores: func.colaboradores.filter(c => supervisoresSelecionados.includes(c.supervisor))
                }));
            }

            dadosResumo.porSupervisor = dadosResumo.porSupervisor.map(sup => {
                const colabs = sup.colaboradores;
                return {
                    ...sup,
                    total: colabs.length,
                    presente: colabs.filter(c => c.status.toLowerCase() === 'presente').length,
                    ausente: colabs.filter(c => c.status.toLowerCase() === 'ausente').length,
                    atestado: colabs.filter(c => c.status.toLowerCase() === 'atestado').length,
                    ferias: colabs.filter(c => c.status.toLowerCase().includes('férias') || c.status.toLowerCase().includes('ferias')).length,
                    folga: colabs.filter(c => c.status.toLowerCase() === 'folga').length,
                    afastado: colabs.filter(c => c.status.toLowerCase() === 'afastado').length,
                    desvio: colabs.filter(c => c.status.toLowerCase() === 'desvio').length,
                    outros: colabs.filter(c => {
                        const st = c.status.toLowerCase();
                        return st !== 'presente' && st !== 'ausente' && st !== 'atestado' && !st.includes('férias') && !st.includes('ferias') && st !== 'folga' && st !== 'afastado' && st !== 'desvio';
                    }).length
                };
            }).filter(sup => sup.total > 0);

            dadosResumo.porFuncao = dadosResumo.porFuncao.map(func => {
                const colabs = func.colaboradores;
                return {
                    ...func,
                    total: colabs.length,
                    presente: colabs.filter(c => c.status.toLowerCase() === 'presente').length,
                    ausente: colabs.filter(c => c.status.toLowerCase() === 'ausente').length,
                    atestado: colabs.filter(c => c.status.toLowerCase() === 'atestado').length,
                    ferias: colabs.filter(c => c.status.toLowerCase().includes('férias') || c.status.toLowerCase().includes('ferias')).length,
                    folga: colabs.filter(c => c.status.toLowerCase() === 'folga').length,
                    afastado: colabs.filter(c => c.status.toLowerCase() === 'afastado').length,
                    desvio: colabs.filter(c => c.status.toLowerCase() === 'desvio').length,
                    outros: colabs.filter(c => {
                        const st = c.status.toLowerCase();
                        return st !== 'presente' && st !== 'ausente' && st !== 'atestado' && !st.includes('férias') && !st.includes('ferias') && st !== 'folga' && st !== 'afastado' && st !== 'desvio';
                    }).length
                };
            }).filter(func => func.total > 0);

            let totalGeral = 0;
            let presenteGeral = 0;
            let ausenteGeral = 0;
            let atestadoGeral = 0;
            let feriasGeral = 0;
            let folgaGeral = 0;
            let afastadoGeral = 0;
            let desvioGeral = 0;
            let outrosGeral = 0;

            dadosResumo.porSupervisor.forEach(sup => {
                totalGeral += sup.total;
                presenteGeral += sup.presente;
                ausenteGeral += sup.ausente;
                atestadoGeral += sup.atestado;
                feriasGeral += sup.ferias;
                folgaGeral += sup.folga;
                afastadoGeral += sup.afastado;
                desvioGeral += sup.desvio;
                outrosGeral += sup.outros;
            });

            dadosResumo.resumoGeral = {
                total: totalGeral,
                presente: presenteGeral,
                ausente: ausenteGeral,
                atestado: atestadoGeral,
                ferias: feriasGeral,
                folga: folgaGeral,
                afastado: afastadoGeral,
                desvio: desvioGeral,
                outros: outrosGeral,
                percentualPresente: totalGeral > 0 ? ((presenteGeral / totalGeral) * 100).toFixed(1) : 0,
                percentualAusente: totalGeral > 0 ? (((totalGeral - presenteGeral) / totalGeral) * 100).toFixed(1) : 0
            };

            renderResumo();
            showStatus(`Filtros aplicados: ${totalGeral} colaboradores encontrados`, 'success');
        }

        function atualizarTagsFiltros(supervisores, funcoes, turnos) {
            const container = document.getElementById('filtrosAtivos');
            let tags = '';

            supervisores.forEach(sup => {
                tags += `<div class="filtro-tag">
                    <span><i class="fas fa-user-tie"></i> ${sup}</span>
                    <i class="fas fa-times" onclick="removerFiltro('supervisor', '${sup}')"></i>
                </div>`;
            });

            funcoes.forEach(func => {
                tags += `<div class="filtro-tag">
                    <span><i class="fas fa-briefcase"></i> ${func}</span>
                    <i class="fas fa-times" onclick="removerFiltro('funcao', '${func}')"></i>
                </div>`;
            });

            turnos.forEach(turno => {
                tags += `<div class="filtro-tag">
                    <span><i class="fas fa-clock"></i> ${turno}</span>
                    <i class="fas fa-times" onclick="removerFiltro('turno', '${turno}')"></i>
                </div>`;
            });

            container.innerHTML = tags;
        }

        function removerFiltro(tipo, valor) {
            const selects = {
                'supervisor': document.getElementById('filtroSupervisor'),
                'funcao': document.getElementById('filtroFuncao'),
                'turno': document.getElementById('filtroTurno')
            };

            const select = selects[tipo];
            if (select) {
                Array.from(select.options).forEach(option => {
                    if (option.value === valor) {
                        option.selected = false;
                    }
                });
            }

            aplicarFiltros();
        }

        function limparFiltros() {
            document.getElementById('filtroSupervisor').selectedIndex = -1;
            document.getElementById('filtroFuncao').selectedIndex = -1;
            document.getElementById('filtroTurno').selectedIndex = -1;
            document.getElementById('filtrosAtivos').innerHTML = '';
            
            if (dadosOriginais) {
                dadosResumo = JSON.parse(JSON.stringify(dadosOriginais));
                renderResumo();
                showStatus('Todos os filtros foram removidos!', 'info');
            }
        }

        function renderResumo() {
            if (!dadosResumo) return;

            const geral = dadosResumo.resumoGeral;
            document.getElementById('resumoGeralCards').innerHTML = `
                <div class="card-resumo">
                    <h3>Total Colaboradores</h3>
                    <div class="valor">${geral.total}</div>
                </div>
                <div class="card-resumo success">
                    <h3>Presentes</h3>
                    <div class="valor">${geral.presente}</div>
                    <div class="percentual">${geral.percentualPresente || 0}%</div>
                </div>
                <div class="card-resumo danger">
                    <h3>Ausentes</h3>
                    <div class="valor">${geral.ausente}</div>
                </div>
                <div class="card-resumo warning">
                    <h3>Atestado</h3>
                    <div class="valor">${geral.atestado || 0}</div>
                </div>
                <div class="card-resumo warning">
                    <h3>Férias</h3>
                    <div class="valor">${geral.ferias}</div>
                </div>
                <div class="card-resumo">
                    <h3>Folga</h3>
                    <div class="valor">${geral.folga}</div>
                </div>
                <div class="card-resumo">
                    <h3>Afastados</h3>
                    <div class="valor">${geral.afastado}</div>
                </div>
                <div class="card-resumo danger">
                    <h3>Desvios</h3>
                    <div class="valor">${geral.desvio || 0}</div>
                </div>
            `;

            renderTabelaSupervisores();
            renderTabelaFuncoes();
            renderTabelaDesvios();
        }

        function renderTabelaSupervisores() {
            const tbody = document.querySelector('#tabelaSupervisores tbody');
            const supervisores = dadosResumo.porSupervisor || [];

            document.getElementById('totalSupervisores').textContent = `${supervisores.length} supervisores`;

            tbody.innerHTML = '';

            supervisores.forEach((sup, idx) => {
                const taxaPresenca = sup.total > 0 ? ((sup.presente / sup.total) * 100).toFixed(1) : 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${sup.supervisor}</strong></td>
                    <td>${sup.total}</td>
                    <td style="color: #28a745; font-weight: 600;">${sup.presente}</td>
                    <td style="color: #dc3545;">${sup.ausente}</td>
                    <td style="color: #ffc107;">${sup.atestado || 0}</td>
                    <td style="color: #ffc107;">${sup.ferias}</td>
                    <td style="color: #17a2b8;">${sup.folga}</td>
                    <td>${sup.afastado}</td>
                    <td style="color: #dc3545; font-weight: 600;">${sup.desvio || 0}</td>
                    <td>${sup.outros}</td>
                    <td>
                        <div class="barra-progresso">
                            <div class="barra-fill" style="width: ${taxaPresenca}%">
                                ${taxaPresenca}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="colab-toggle" onclick="toggleColaboradores('sup-${idx}')">
                            <i class="fas fa-users"></i> Ver ${sup.colaboradores.length}
                        </span>
                        <div id="sup-${idx}" class="colaboradores-lista">
                            ${sup.colaboradores.map(c => `
                                <div class="colaborador-item">
                                    <strong>${c.nome}</strong> (${c.matricula}) - <strong>${c.funcao}</strong> - Turno: ${c.turno} - 
                                    <span style="color: ${c.status === 'Presente' ? '#28a745' : c.status === 'Desvio' ? '#dc3545' : '#6c757d'};">
                                        ${c.status}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderTabelaFuncoes() {
            const tbody = document.querySelector('#tabelaFuncoes tbody');
            const funcoes = dadosResumo.porFuncao || [];

            document.getElementById('totalFuncoes').textContent = `${funcoes.length} funções`;

            tbody.innerHTML = '';

            funcoes.forEach((func, idx) => {
                const taxaPresenca = func.total > 0 ? ((func.presente / func.total) * 100).toFixed(1) : 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${func.funcao}</strong></td>
                    <td>${func.total}</td>
                    <td style="color: #28a745; font-weight: 600;">${func.presente}</td>
                    <td style="color: #dc3545;">${func.ausente}</td>
                    <td style="color: #ffc107;">${func.atestado || 0}</td>
                    <td style="color: #ffc107;">${func.ferias}</td>
                    <td style="color: #17a2b8;">${func.folga}</td>
                    <td>${func.afastado}</td>
                    <td style="color: #dc3545; font-weight: 600;">${func.desvio || 0}</td>
                    <td>${func.outros}</td>
                    <td>
                        <div class="barra-progresso">
                            <div class="barra-fill" style="width: ${taxaPresenca}%">
                                ${taxaPresenca}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="colab-toggle" onclick="toggleColaboradores('func-${idx}')">
                            <i class="fas fa-users"></i> Ver ${func.colaboradores.length}
                        </span>
                        <div id="func-${idx}" class="colaboradores-lista">
                            ${func.colaboradores.map(c => `
                                <div class="colaborador-item">
                                    <strong>${c.nome}</strong> (${c.matricula}) - ${c.supervisor} - Turno: ${c.turno} - 
                                    <span style="color: ${c.status === 'Presente' ? '#28a745' : c.status === 'Desvio' ? '#dc3545' : '#6c757d'};">
                                        ${c.status}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderTabelaDesvios() {
            const tbody = document.querySelector('#tabelaDesvios tbody');
            tbody.innerHTML = '';
            
            const desvios = [];
            
            dadosResumo.porSupervisor.forEach(sup => {
                sup.colaboradores.forEach(colab => {
                    if (colab.status.toLowerCase() === 'desvio') {
                        desvios.push({
                            ...colab,
                            supervisor: sup.supervisor
                        });
                    }
                });
            });

            document.getElementById('totalDesvios').textContent = `${desvios.length} desvios`;

            if (desvios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #28a745;">
                            <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px;"></i>
                            <p style="font-size: 16px; font-weight: 600;">Nenhum desvio encontrado para esta data!</p>
                        </td>
                    </tr>
                `;
                return;
            }

            desvios.forEach(desvio => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${desvio.nome}</strong></td>
                    <td>${desvio.matricula}</td>
                    <td>${desvio.funcao}</td>
                    <td>${desvio.supervisor}</td>
                    <td>${desvio.turno}</td>
                    <td><span style="color: #dc3545; font-weight: 600;">${desvio.status}</span></td>
                    <td>${desvio.observacao || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleColaboradores(id) {
            const div = document.getElementById(id);
            div.classList.toggle('show');
        }

        function exportarResumo() {
            if (!dadosResumo) {
                showStatus('Carregue os dados primeiro', 'error');
                return;
            }

            let csv = 'Tipo,Nome,Total,Presente,Ausente,Atestado,Férias,Folga,Afastado,Desvio,Outros,Taxa Presença\n';
            
            dadosResumo.porSupervisor.forEach(sup => {
                const taxa = sup.total > 0 ? ((sup.presente / sup.total) * 100).toFixed(1) : 0;
                csv += `Supervisor,"${sup.supervisor}",${sup.total},${sup.presente},${sup.ausente},${sup.atestado || 0},${sup.ferias},${sup.folga},${sup.afastado},${sup.desvio || 0},${sup.outros},${taxa}%\n`;
            });

            csv += '\n';

            dadosResumo.porFuncao.forEach(func => {
                const taxa = func.total > 0 ? ((func.presente / func.total) * 100).toFixed(1) : 0;
                csv += `Função,"${func.funcao}",${func.total},${func.presente},${func.ausente},${func.atestado || 0},${func.ferias},${func.folga},${func.afastado},${func.desvio || 0},${func.outros},${taxa}%\n`;
            });

            csv += '\n\nDetalhamento de Desvios\n';
            csv += 'Colaborador,Matrícula,Função,Supervisor,Turno,Status,Observações\n';

            dadosResumo.porSupervisor.forEach(sup => {
                sup.colaboradores.forEach(colab => {
                    if (colab.status.toLowerCase() === 'desvio') {
                        csv += `"${colab.nome}",${colab.matricula},"${colab.funcao}","${sup.supervisor}","${colab.turno}","${colab.status}","${colab.observacao || '-'}"\n`;
                    }
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Resumo_Base_${dadosResumo.dataReferencia || 'hoje'}.csv`;
            link.click();

            showStatus('Resumo exportado com sucesso!', 'success');
        }

        window.onload = function() {
            const usuario = sessionStorage.getItem('usuario');
            if (!usuario) {
                showStatus('Sessão expirada', 'error');
                setTimeout(() => window.location.href = '/', 2000);
                return;
            }

            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('filtroData').value = hoje;

            carregarResumo();
        };

        console.log('Resumo Base carregado');
    </script>
</body>
</html>
