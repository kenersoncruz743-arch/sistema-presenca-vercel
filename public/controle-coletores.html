<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Coletores e Chaves RFID</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: flex;
      background-color: #f5f5f5;
    }
    
    /* ===== NAVEGAÃ‡ÃƒO ENTRE PÃGINAS ===== */
    .page-navigation {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      gap: 10px;
    }
    
    .nav-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nav-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
    }
    
    .nav-btn.active {
      background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .page-container {
      display: none;
      width: 100%;
    }
    
    .page-container.active {
      display: flex;
    }
    
    /* ===== ESTILOS COMUNS ===== */
    .form-container {
      width: 300px;
      margin-right: 30px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 20px;
      align-self: flex-start;
    }
    
    h2 {
      color: #333;
      margin-bottom: 20px;
    }
    
    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
      color: #555;
    }
    
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    input:disabled {
      background-color: #f0f0f0;
      cursor: not-allowed;
    }
    
    .situacao-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 15px;
    }
    
    .situacao-group input[type="radio"] {
      display: none;
    }
    
    .situacao-group label {
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 8px 12px;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s;
      font-size: 13px;
    }
    
    .situacao-group label:hover {
      background-color: #e0e0e0;
    }
    
    .situacao-group input[type="radio"]:checked + label {
      background-color: #007BFF;
      color: white;
      border-color: #007BFF;
    }
    
    #ok:checked + label {
      background-color: #28a745 !important;
      border-color: #28a745 !important;
    }
    
    .situacao-group input[type="radio"]:checked + label:not([for="ok"]) {
      background-color: #dc3545 !important;
      border-color: #dc3545 !important;
    }
    
    button {
      background-color: #007BFF;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      width: 48%;
      transition: background-color 0.3s;
    }
    
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .button-group {
      display: flex;
      justify-content: space-between;
      gap: 4%;
    }
    
    .painel-central {
      display: flex;
      flex: 1;
      gap: 30px;
    }
    
    .coletor-container, .chave-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .coletor-container > h3, .chave-container > h3 {
      color: #333;
      margin-bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .blocos-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .bloco {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      background: white;
    }
    
    .coletor, .chave {
      width: 35px;
      height: 35px;
      background-color: #e0e0e0;
      border: 2px solid #aaa;
      border-radius: 5px;
      text-align: center;
      line-height: 35px;
      cursor: default;
      position: relative;
      font-size: 13px;
      font-weight: bold;
      transition: transform 0.2s;
    }
    
    .coletor:hover, .chave:hover {
      transform: scale(1.1);
      z-index: 5;
    }
    
    .coletor[data-status="azul"], .chave[data-status="azul"] {
      background-color: #003366;
      color: white;
      border-color: #002244;
    }
    
    .coletor[data-status="laranja"], .chave[data-status="laranja"] {
      background-color: #FFA500;
      color: black;
      border-color: #cc8400;
    }
    
    .coletor[data-status="vermelho"], .chave[data-status="vermelho"] {
      background-color: #cc0000;
      color: white;
      border-color: #990000;
    }
    
    .coletor:hover::after, .chave:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      white-space: pre-line;
      font-size: 12px;
      z-index: 10;
      min-width: 150px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .resumo-container {
      width: 280px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      background-color: white;
      font-size: 14px;
      position: sticky;
      top: 20px;
      align-self: flex-start;
    }
    
    .resumo-container h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #007BFF;
      padding-bottom: 10px;
    }
    
    .resumo-item {
      margin-bottom: 12px;
      padding: 8px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    
    .resumo-item strong {
      color: #007BFF;
    }
    
    #resumoPorSupervisor, #resumoPorSupervisorChaves {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }
    
    #resumoPorSupervisor h4, #resumoPorSupervisorChaves h4 {
      margin: 0 0 15px;
      font-weight: bold;
      color: #007BFF;
      font-size: 16px;
    }
    
    #mensagem, #mensagemChave {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
      text-align: center;
    }
    
    #mensagem.sucesso, #mensagemChave.sucesso {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    #mensagem.erro, #mensagemChave.erro {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    @media (max-width: 1200px) {
      .page-navigation {
        position: static;
        margin-bottom: 20px;
        justify-content: center;
      }
      
      body {
        flex-direction: column;
      }
      
      .form-container {
        width: 100%;
        margin-right: 0;
        margin-bottom: 20px;
      }
      
      .painel-central {
        flex-direction: column;
      }
      
      .resumo-container {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- NavegaÃ§Ã£o entre pÃ¡ginas -->
  <div class="page-navigation">
    <button class="nav-btn active" onclick="trocarPagina('coletores')" id="btnColetores">
      ðŸ“± Coletores RFID
    </button>
    <button class="nav-btn" onclick="trocarPagina('chaves')" id="btnChaves">
      ðŸ”‘ Chaves
    </button>
  </div>

  <!-- ===================== PÃGINA COLETORES ===================== -->
  <div id="pageColetores" class="page-container active">
    <div class="form-container">
      <h2>Registro de Coletor</h2>

      <label for="chapa">Chapa:</label>
      <input type="number" id="chapa" placeholder="Digite a chapa">

      <label for="nome">Nome:</label>
      <input type="text" id="nome" disabled>

      <label for="funcao">FunÃ§Ã£o:</label>
      <input type="text" id="funcao" disabled>

      <label for="numero">NÃºmero do Coletor:</label>
      <input type="number" id="numero" min="1" max="140" step="1" placeholder="1 a 140">

      <label for="tipo">Tipo de OperaÃ§Ã£o:</label>
      <select id="tipo">
        <option value="Entrega">Entrega</option>
        <option value="Retirada">Retirada</option>
      </select>

      <label>SituaÃ§Ã£o:</label>
      <div class="situacao-group">
        <input type="radio" name="situacao" id="ok" value="OK">
        <label for="ok">OK</label>
        
        <input type="radio" name="situacao" id="tela" value="Tela quebrada">
        <label for="tela">Tela quebrada</label>
        
        <input type="radio" name="situacao" id="botao" value="BotÃ£o travado">
        <label for="botao">BotÃ£o travado</label>
        
        <input type="radio" name="situacao" id="carregador" value="Sem carregador">
        <label for="carregador">Sem carregador</label>
        
        <input type="radio" name="situacao" id="outro" value="Outro">
        <label for="outro">Outro</label>
      </div>

      <div class="button-group">
        <button onclick="salvarColetor()">Salvar</button>
        <button onclick="limparCamposColetores()">Limpar</button>
      </div>

      <div id="mensagem"></div>
    </div>

    <div class="painel-central">
      <div class="coletor-container">
        <h3>Status dos Coletores (1-140)</h3>
        <div class="blocos-container" id="coletorBlocos">
          <div class="loading">Carregando coletores...</div>
        </div>
      </div>

      <div class="resumo-container">
        <h3>Resumo Coletores</h3>
        <div id="resumo">
          <div class="loading">Carregando...</div>
        </div>
        
        <div id="resumoPorSupervisor">
          <h4>Retiradas por Supervisor</h4>
          <div id="supervisorCounts">
            <div class="loading">Carregando...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== PÃGINA CHAVES ===================== -->
  <div id="pageChaves" class="page-container">
    <div class="form-container">
      <h2>Registro de Chave</h2>

      <label for="chapaChave">Chapa:</label>
      <input type="number" id="chapaChave" placeholder="Digite a chapa">

      <label for="nomeChave">Nome:</label>
      <input type="text" id="nomeChave" disabled>

      <label for="funcaoChave">FunÃ§Ã£o:</label>
      <input type="text" id="funcaoChave" disabled>

      <label for="numeroChave">NÃºmero da Chave:</label>
      <input type="number" id="numeroChave" min="1" max="60" step="1" placeholder="1 a 60">

      <label for="tipoChave">Tipo de OperaÃ§Ã£o:</label>
      <select id="tipoChave">
        <option value="Entrega">Entrega</option>
        <option value="Retirada">Retirada</option>
      </select>

      <label>SituaÃ§Ã£o:</label>
      <div class="situacao-group">
        <input type="radio" name="situacaoChave" id="okChave" value="OK">
        <label for="okChave">OK</label>
        
        <input type="radio" name="situacaoChave" id="danificadaChave" value="Danificada">
        <label for="danificadaChave">Danificada</label>
        
        <input type="radio" name="situacaoChave" id="perdidaChave" value="Perdida">
        <label for="perdidaChave">Perdida</label>
        
        <input type="radio" name="situacaoChave" id="outroChave" value="Outro">
        <label for="outroChave">Outro</label>
      </div>

      <div class="button-group">
        <button onclick="salvarChave()">Salvar</button>
        <button onclick="limparCamposChaves()">Limpar</button>
      </div>

      <div id="mensagemChave"></div>
    </div>

    <div class="painel-central">
      <div class="chave-container">
        <h3>Status das Chaves (1-60)</h3>
        <div class="blocos-container" id="chaveBlocos">
          <div class="loading">Carregando chaves...</div>
        </div>
      </div>

      <div class="resumo-container">
        <h3>Resumo Chaves</h3>
        <div id="resumoChaves">
          <div class="loading">Carregando...</div>
        </div>
        
        <div id="resumoPorSupervisorChaves">
          <h4>Retiradas por Supervisor</h4>
          <div id="supervisorCountsChaves">
            <div class="loading">Carregando...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIGURAÃ‡ÃƒO GLOBAL =====
    const API_URL = `${window.location.origin}/api/coletores`;
    
    console.log('[SISTEMA] URL da API:', API_URL);
    
    let dadosColaboradores = [];
    let paginaAtual = 'coletores';
    
    // ===== NAVEGAÃ‡ÃƒO ENTRE PÃGINAS =====
    function trocarPagina(pagina) {
      // Esconde todas as pÃ¡ginas
      document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      
      // Mostra pÃ¡gina selecionada
      if (pagina === 'coletores') {
        document.getElementById('pageColetores').classList.add('active');
        document.getElementById('btnColetores').classList.add('active');
        paginaAtual = 'coletores';
        carregarStatusColetores();
      } else if (pagina === 'chaves') {
        document.getElementById('pageChaves').classList.add('active');
        document.getElementById('btnChaves').classList.add('active');
        paginaAtual = 'chaves';
        carregarStatusChaves();
      }
      
      console.log('[SISTEMA] PÃ¡gina alterada para:', pagina);
    }
    
    // ===== FUNÃ‡Ã•ES COMPARTILHADAS =====
    async function apiRequest(action, data = {}) {
      try {
        console.log('[API] Fazendo requisiÃ§Ã£o:', { action, data });
        
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ action, ...data })
        });
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[API] Resposta:', result);
        
        return result;
      } catch (error) {
        console.error('[API] Erro na requisiÃ§Ã£o:', error);
        throw error;
      }
    }
    
    async function carregarColaboradores() {
      try {
        console.log('[SISTEMA] Carregando colaboradores...');
        
        const resultado = await apiRequest('obterDados');
        
        if (resultado.ok) {
          dadosColaboradores = resultado.dados;
          console.log(`[SISTEMA] ${resultado.total} colaboradores carregados`);
        } else {
          console.error('[SISTEMA] Erro:', resultado.msg);
        }
      } catch (error) {
        console.error('[SISTEMA] Erro ao carregar colaboradores:', error);
        mostrarMensagem('Erro ao carregar colaboradores', 'erro');
      }
    }
    
    function mostrarMensagem(texto, tipo, elemento = 'mensagem') {
      const mensagemDiv = document.getElementById(elemento);
      mensagemDiv.textContent = texto;
      mensagemDiv.className = tipo;
    }
    
    // ==================== FUNÃ‡Ã•ES COLETORES ====================
    
    document.getElementById("chapa").addEventListener("blur", () => {
      const chapa = document.getElementById("chapa").value.trim();
      const nomeInput = document.getElementById("nome");
      const funcaoInput = document.getElementById("funcao");
      
      if (!chapa) {
        nomeInput.value = "";
        funcaoInput.value = "";
        return;
      }
      
      const colaborador = dadosColaboradores.find(p => p.chapa === chapa);
      if (colaborador) {
        nomeInput.value = colaborador.nome;
        funcaoInput.value = colaborador.funcao;
      } else {
        nomeInput.value = "";
        funcaoInput.value = "";
        mostrarMensagem('Colaborador nÃ£o encontrado', 'erro', 'mensagem');
      }
    });
    
    async function salvarColetor() {
      const botaoSalvar = document.querySelector("#pageColetores button[onclick='salvarColetor()']");
      const mensagemDiv = document.getElementById("mensagem");
      
      if (botaoSalvar.disabled) return;
      
      botaoSalvar.disabled = true;
      botaoSalvar.textContent = "Salvando...";
      mensagemDiv.className = "";
      mensagemDiv.textContent = "";
      
      const chapa = document.getElementById("chapa").value.trim();
      const nome = document.getElementById("nome").value.trim();
      const funcao = document.getElementById("funcao").value.trim();
      const numero = parseInt(document.getElementById("numero").value, 10);
      const tipo = document.getElementById("tipo").value;
      const situacaoSelecionada = document.querySelector("input[name='situacao']:checked");
      
      if (!chapa) {
        mostrarMensagem("Preencha a chapa do colaborador.", "erro", "mensagem");
        botaoSalvar.disabled = false;
        botaoSalvar.textContent = "Salvar";
        return;
      }
      
      if (!nome) {
        mostrarMensagem("Colaborador nÃ£o encontrado. Verifique a chapa.", "erro", "mensagem");
        botaoSalvar.disabled = false;
        botaoSalvar.textContent = "Salvar";
        return;
      }
      
      if (isNaN(numero) || numero < 1 || numero > 140) {
        mostrarMensagem("NÃºmero do coletor deve ser entre 1 e 140.", "erro", "mensagem");
        botaoSalvar.disabled = false;
        botaoSalvar.textContent = "Salvar";
        return;
      }
      
      if (!situacaoSelecionada) {
        mostrarMensagem("Selecione uma situaÃ§Ã£o.", "erro", "mensagem");
        botaoSalvar.disabled = false;
        botaoSalvar.textContent = "Salvar";
        return;
      }
      
      const situacoes = [situacaoSelecionada.value];
      
      try {
        console.log('[COLETOR] Enviando registro:', {
          chapa, nome, funcao, numeroColetor: numero, tipoOperacao: tipo, situacoes
        });
        
        const resultado = await apiRequest('salvarRegistro', {
          chapa,
          nome,
          funcao,
          numeroColetor: numero,
          tipoOperacao: tipo,
          situacoes
        });
        
        if (resultado.ok) {
          mostrarMensagem(resultado.msg, "sucesso", "mensagem");
          limparCamposColetores();
          await carregarStatusColetores();
        } else {
          mostrarMensagem(resultado.msg, "erro", "mensagem");
        }
      } catch (error) {
        mostrarMensagem("Erro ao salvar registro. Tente novamente.", "erro", "mensagem");
        console.error('[COLETOR] Erro:', error);
      } finally {
        botaoSalvar.disabled = false;
        botaoSalvar.textContent = "Salvar";
      }
    }
    
    function limparCamposColetores() {
      document.getElementById("chapa").value = "";
      document.getElementById("nome").value = "";
      document.getElementById("funcao").value = "";
      document.getElementById("numero").value = "";
      document.getElementById("tipo").value = "Entrega";
      const situacoes = document.querySelectorAll("input[name='situacao']");
      situacoes.forEach(r => r.checked = false);
      
      const mensagemDiv = document.getElementById("mensagem");
      setTimeout(() => {
        mensagemDiv.className = "";
        mensagemDiv.textContent = "";
      }, 3000);
    }
    
    async function carregarStatusColetores() {
      try {
        console.log('[COLETOR] Carregando status dos coletores...');
        
        const [statusResult, supervisorResult] = await Promise.all([
          apiRequest('obterColetorStatus'),
          apiRequest('obterResumoPorSupervisor')
        ]);
        
        if (statusResult.ok) {
          renderizarColetores(statusResult.statusMap);
        }
        
        if (supervisorResult.ok) {
          renderizarResumoPorSupervisor(supervisorResult.resumoPorSupervisor);
        }
      } catch (error) {
        console.error('[COLETOR] Erro ao carregar status:', error);
        document.getElementById("coletorBlocos").innerHTML = 
          '<div class="loading">Erro ao carregar coletores. Tente recarregar a pÃ¡gina.</div>';
      }
    }
    
    function renderizarColetores(statusMap) {
      const blocosContainer = document.getElementById("coletorBlocos");
      blocosContainer.innerHTML = "";
      
      const coletoresPorBloco = 20;
      
      for (let bloco = 0; bloco < 7; bloco++) {
        const divBloco = document.createElement("div");
        divBloco.className = "bloco";
        
        for (let i = 1; i <= coletoresPorBloco; i++) {
          const numero = bloco * coletoresPorBloco + i;
          const div = document.createElement("div");
          div.className = "coletor";
          div.textContent = numero;
          
          const info = statusMap[numero];
          if (info) {
            const status = info.situacao.includes("OK")
              ? (info.tipo === "Entrega" ? "azul" : "laranja")
              : "vermelho";
            div.setAttribute("data-status", status);
            
            let tooltip = `Coletor ${numero}\n`;
            tooltip += `${info.nome} (${info.chapa})\n`;
            tooltip += `${info.tipo}\n`;
            tooltip += `SituaÃ§Ã£o: ${info.situacao}`;
            if (info.supervisor) {
              tooltip += `\nSupervisor: ${info.supervisor}`;
            }
            tooltip += `\n${info.data}`;
            
            div.setAttribute("data-tooltip", tooltip);
          }
          
          divBloco.appendChild(div);
        }
        
        blocosContainer.appendChild(divBloco);
      }
      
      const resumoDiv = document.getElementById("resumo");
      resumoDiv.innerHTML = "";
      
      const statusContagem = { azul: 0, laranja: 0, vermelho: 0 };
      
      Object.values(statusMap).forEach(info => {
        const status = info.situacao.includes("OK")
          ? (info.tipo === "Entrega" ? "azul" : "laranja")
          : "vermelho";
        statusContagem[status]++;
      });
      
      const resumoHTML = `
        <div class="resumo-item">
          <strong style="color:#003366;">ðŸ”µ DisponÃ­veis:</strong> ${statusContagem.azul}
        </div>
        <div class="resumo-item">
          <strong style="color:#FFA500;">ðŸŸ  Em Retirada:</strong> ${statusContagem.laranja}
        </div>
        <div class="resumo-item">
          <strong style="color:#cc0000;">ðŸ”´ Com Problema:</strong> ${statusContagem.vermelho}
        </div>
        <div class="resumo-item">
          <strong>Total de Coletores:</strong> ${Object.keys(statusMap).length}
        </div>
      `;
      
      resumoDiv.innerHTML = resumoHTML;
    }
    
    function renderizarResumoPorSupervisor(resumoPorSupervisor) {
      const supervisorDiv = document.getElementById("supervisorCounts");
      
      if (!resumoPorSupervisor || Object.keys(resumoPorSupervisor).length === 0) {
        supervisorDiv.innerHTML = "<p style='color:#999;'>Nenhum registro de retirada hoje.</p>";
        return;
      }
      
      let supHTML = "";
      const supervisores = Object.entries(resumoPorSupervisor)
        .sort((a, b) => b[1].retiradaContada - a[1].retiradaContada);
      
      for (const [sup, dados] of supervisores) {
        supHTML += `
          <div class="resumo-item">
            <strong>${sup}:</strong> ${dados.retiradaContada}
          </div>
        `;
      }
      
      supervisorDiv.innerHTML = supHTML;
    }
    
    // ==================== FUNÃ‡Ã•ES CHAVES ====================
    
    document.getElementById("chapaChave").addEventListener("blur", () => {
      const chapa = document.getElementById("chapaChave").value.trim();
      const nomeInput = document.getElementById("nomeChave");
      const funcaoInput = document.getElementById("funcaoChave");
      
      if (!chapa) {
        nomeInput.value = "";
        funcaoInput.value = "";
        return;
      }
      
      const colaborador = dadosColaboradores.find(p => p.chapa === chapa);
      if (colaborador) {
        nomeInput.value = colaborador.nome;
        funcaoInput.value = colaborador.funcao;
      } else {
        nomeInput.value = "";
        funcaoInput.value = "";
        mostrarMensagem('Colaborador nÃ£o encontrado', 'erro', 'mensagemChave');
      }
    });
    
    async function salvarChave() {
      const botaoSalvar = document.querySelector("#pageChaves button[onclick='salvarChave()']");
      const mensagemDiv = document.getElementById("mensagemChave");
      
      if (botaoSalvar.disabled) return;
      
      botaoSalvar.disabled = true;
      botaoSalvar.textContent = "Salvando...";
      mensagemDiv.className = "";
      mensagemDiv.textContent = "";
      
      const chapa = document.getElementById("chapaChave").value.trim();
      const nome = document.getElementById("nomeChave").value.trim();
      const funcao = document.getElementById("funcaoChave").value.trim();
      const numero = parseInt(document.getElementById("numeroChave").value, 10);
      const tipo = document.getElementById("tipoChave").value;
      const situacaoSelecionada = document.querySelector("input[name='situacaoChave']:checked");
      
      if (!chapa) {
        mostrarMensagem("Preencha a chapa do colaborador.", "erro", "mensagemChave");
        botaoSalvar.disabled = false;
        botaoSalvar.textContent = "Salvar";
        return;
      }
      
      if (!nome) {
        mostrarMensagem("Colaborador nÃ£o encontrado. Verifique a chapa.", "erro", "mensagemChave");
        botaoSalvar.disabled = false;
        botaoSalvar.textContent = "Salvar";
        return;
      }
      
      if (isNaN(numero) || numero < 1 || numero > 60) {
        mostrarMensagem("NÃºmero da chave deve ser entre 1 e 60.", "erro", "mensagemChave");
        botaoSalvar.disabled = false;
        botaoSalvar.textContent = "Salvar";
        return;
      }
      
      if (!situacaoSelecionada) {
        mostrarMensagem("Selecione uma situaÃ§Ã£o.", "erro", "mensagemChave");
        botaoSalvar.disabled = false;
        botaoSalvar.textContent = "Salvar";
        return;
      }
      
      const situacoes = [situacaoSelecionada.value];
      
      try {
        console.log('[CHAVE] Enviando registro:', {
          chapa, nome, funcao, numeroChave: numero, tipoOperacao: tipo, situacoes
        });
        
        const resultado = await apiRequest('salvarRegistroChave', {
          chapa,
          nome,
          funcao,
          numeroChave: numero,
          tipoOperacao: tipo,
          situacoes
        });
        
        if (resultado.ok) {
          mostrarMensagem(resultado.msg, "sucesso", "mensagemChave");
          limparCamposChaves();
          await carregarStatusChaves();
        } else {
          mostrarMensagem(resultado.msg, "erro", "mensagemChave");
        }
      } catch (error) {
        mostrarMensagem("Erro ao salvar registro. Tente novamente.", "erro", "mensagemChave");
        console.error('[CHAVE] Erro:', error);
      } finally {
        botaoSalvar.disabled = false;
        botaoSalvar.textContent = "Salvar";
      }
    }
    
    function limparCamposChaves() {
      document.getElementById("chapaChave").value = "";
      document.getElementById("nomeChave").value = "";
      document.getElementById("funcaoChave").value = "";
      document.getElementById("numeroChave").value = "";
      document.getElementById("tipoChave").value = "Entrega";
      const situacoes = document.querySelectorAll("input[name='situacaoChave']");
      situacoes.forEach(r => r.checked = false);
      
      const mensagemDiv = document.getElementById("mensagemChave");
      setTimeout(() => {
        mensagemDiv.className = "";
        mensagemDiv.textContent = "";
      }, 3000);
    }
    
    async function carregarStatusChaves() {
      try {
        console.log('[CHAVE] Carregando status das chaves...');
        
        const [statusResult, supervisorResult] = await Promise.all([
          apiRequest('obterChaveStatus'),
          apiRequest('obterResumoPorSupervisorChaves')
        ]);
        
        if (statusResult.ok) {
          renderizarChaves(statusResult.statusMap);
        }
        
        if (supervisorResult.ok) {
          renderizarResumoPorSupervisorChaves(supervisorResult.resumoPorSupervisor);
        }
      } catch (error) {
        console.error('[CHAVE] Erro ao carregar status:', error);
        document.getElementById("chaveBlocos").innerHTML = 
          '<div class="loading">Erro ao carregar chaves. Tente recarregar a pÃ¡gina.</div>';
      }
    }
    
    function renderizarChaves(statusMap) {
      const blocosContainer = document.getElementById("chaveBlocos");
      blocosContainer.innerHTML = "";
      
      const chavesPorBloco = 20;
      
      for (let bloco = 0; bloco < 3; bloco++) {
        const divBloco = document.createElement("div");
        divBloco.className = "bloco";
        
        const inicio = bloco * chavesPorBloco + 1;
        const fim = Math.min((bloco + 1) * chavesPorBloco, 60);
        
        for (let numero = inicio; numero <= fim; numero++) {
          const div = document.createElement("div");
          div.className = "chave";
          div.textContent = numero;
          
          const info = statusMap[numero];
          if (info) {
            const status = info.situacao.includes("OK")
              ? (info.tipo === "Entrega" ? "azul" : "laranja")
              : "vermelho";
            div.setAttribute("data-status", status);
            
            let tooltip = `Chave ${numero}\n`;
            tooltip += `${info.nome} (${info.chapa})\n`;
            tooltip += `${info.tipo}\n`;
            tooltip += `SituaÃ§Ã£o: ${info.situacao}`;
            if (info.supervisor) {
              tooltip += `\nSupervisor: ${info.supervisor}`;
            }
            tooltip += `\n${info.data}`;
            
            div.setAttribute("data-tooltip", tooltip);
          }
          
          divBloco.appendChild(div);
        }
        
        blocosContainer.appendChild(divBloco);
      }
      
      const resumoDiv = document.getElementById("resumoChaves");
      resumoDiv.innerHTML = "";
      
      const statusContagem = { azul: 0, laranja: 0, vermelho: 0 };
      
      Object.values(statusMap).forEach(info => {
        const status = info.situacao.includes("OK")
          ? (info.tipo === "Entrega" ? "azul" : "laranja")
          : "vermelho";
        statusContagem[status]++;
      });
      
      const resumoHTML = `
        <div class="resumo-item">
          <strong style="color:#003366;">ðŸ”µ DisponÃ­veis:</strong> ${statusContagem.azul}
        </div>
        <div class="resumo-item">
          <strong style="color:#FFA500;">ðŸŸ  Em Retirada:</strong> ${statusContagem.laranja}
        </div>
        <div class="resumo-item">
          <strong style="color:#cc0000;">ðŸ”´ Com Problema:</strong> ${statusContagem.vermelho}
        </div>
        <div class="resumo-item">
          <strong>Total de Chaves:</strong> ${Object.keys(statusMap).length}
        </div>
      `;
      
      resumoDiv.innerHTML = resumoHTML;
    }
    
    function renderizarResumoPorSupervisorChaves(resumoPorSupervisor) {
      const supervisorDiv = document.getElementById("supervisorCountsChaves");
      
      if (!resumoPorSupervisor || Object.keys(resumoPorSupervisor).length === 0) {
        supervisorDiv.innerHTML = "<p style='color:#999;'>Nenhum registro de retirada hoje.</p>";
        return;
      }
      
      let supHTML = "";
      const supervisores = Object.entries(resumoPorSupervisor)
        .sort((a, b) => b[1].retiradaContada - a[1].retiradaContada);
      
      for (const [sup, dados] of supervisores) {
        supHTML += `
          <div class="resumo-item">
            <strong>${sup}:</strong> ${dados.retiradaContada}
          </div>
        `;
      }
      
      supervisorDiv.innerHTML = supHTML;
    }
    
    // ==================== INICIALIZAÃ‡ÃƒO ====================
    
    window.onload = async () => {
      console.log('[SISTEMA] Inicializando aplicaÃ§Ã£o...');
      
      await carregarColaboradores();
      await carregarStatusColetores();
      
      // Auto-refresh a cada 30 segundos
      setInterval(() => {
        if (paginaAtual === 'coletores') {
          carregarStatusColetores();
        } else if (paginaAtual === 'chaves') {
          carregarStatusChaves();
        }
      }, 30000);
      
      console.log('[SISTEMA] âœ“ AplicaÃ§Ã£o inicializada');
    };
  </script>
</body>
</html>
