<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auditoria de Avaria</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f9f9f9;padding:20px}
.container{max-width:90%;margin:0 auto;background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
h2{text-align:center;margin-bottom:20px;font-size:52px;color:#333}
label{font-weight:bold;display:block;margin-top:12px;font-size:40px}
input,select{width:100%;padding:28px;margin-top:6px;margin-bottom:12px;box-sizing:border-box;font-size:28px;border:1px solid #ccc;border-radius:4px}
.button-group{display:flex;gap:8px;margin-top:20px}
button{background:#007BFF;color:white;padding:26px 0;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:26px;flex:1;transition:background 0.3s}
button:hover:not(:disabled){background:#0056b3}
button:disabled{background:#a0a0a0;cursor:not-allowed}
#mensagemCodigo,#mensagem{color:red;font-weight:bold;margin-top:10px;font-size:20px;text-align:center}
.user-info{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center;font-size:24px}
.debug-info{background:#f0f0f0;padding:10px;margin-top:10px;font-size:14px;border-radius:4px;display:none}
.stats{background:#e3f2fd;padding:10px;border-radius:4px;margin-bottom:10px;font-size:14px}
</style>
</head>
<body>
<div class="container">
<div class="user-info">üë§ Usu√°rio: <span id="userName">Carregando...</span></div>
<h2>Auditoria de Avaria</h2>

<div id="statsInfo" class="stats" style="display:none"></div>

<label for="codigoProduto">C√≥digo do Produto (EAN/DUN/COD):</label>
<input type="text" id="codigoProduto" placeholder="Digite ou escaneie o c√≥digo" autofocus>
<div id="mensagemCodigo"></div>
<div id="debugInfo" class="debug-info"></div>

<label for="descricaoProduto">Descri√ß√£o:</label>
<input type="text" id="descricaoProduto" disabled>

<label for="embalagemProduto">Embalagem:</label>
<input type="text" id="embalagemProduto" disabled>

<label for="motivo">Motivo da Avaria:</label>
<select id="motivo">
<option value="">Selecione o motivo</option>
<option value="Avaria na movimenta√ß√£o">Avaria na movimenta√ß√£o</option>
<option value="Avaria por roedores">Avaria por roedores</option>
<option value="Qualidade">Qualidade</option>
<option value="Vencimento">Vencimento</option>
<option value="Reaproveitamento">Reaproveitamento</option>
<option value="Avaria por macaco">Avaria por macaco</option>
<option value="Desvio">Desvio</option>
</select>

<label for="quantidade">Quantidade Avariada:</label>
<input type="number" id="quantidade" min="1" max="9999" step="1" placeholder="1 a 9999">

<div class="button-group">
<button id="btnSalvar" onclick="salvar()" disabled>Salvar</button>
<button onclick="limparCampos()">Limpar</button>
<button onclick="window.location.href='/menu'">Voltar</button>
</div>

<div id="mensagem"></div>
</div>

<script>
const API_BASE = window.location.origin;
let mapaBusca = new Map();
let listaProdutos = [];
let usuarioLogado = '';
let debugMode = false;

function showDebug(msg) {
  if (debugMode) {
    const debugDiv = document.getElementById('debugInfo');
    debugDiv.style.display = 'block';
    debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${msg}</div>`;
  }
  console.log('[AVARIA]', msg);
}

function atualizarStats() {
  const statsDiv = document.getElementById('statsInfo');
  if (listaProdutos.length > 0) {
    const totalCodigos = mapaBusca.size;
    statsDiv.innerHTML = `
      üì¶ <strong>${listaProdutos.length}</strong> produtos cadastrados | 
      üîç <strong>${totalCodigos}</strong> c√≥digos indexados para busca
    `;
    statsDiv.style.display = 'block';
  }
}

// Normaliza c√≥digo (remove zeros √† esquerda)
function normalizarCodigo(codigo) {
  if (!codigo) return '';
  
  let normalizado = String(codigo).trim();
  
  // Remove zeros √† esquerda, exceto se for s√≥ "0"
  if (normalizado !== '0') {
    normalizado = normalizado.replace(/^0+/, '');
  }
  
  if (normalizado === '') normalizado = '0';
  
  return normalizado;
}

// Busca produto ao digitar
document.getElementById("codigoProduto").addEventListener("input", () => {
  buscarProduto();
});

// Busca ao pressionar Enter
document.getElementById("codigoProduto").addEventListener("keypress", (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    buscarProduto();
    const descricao = document.getElementById("descricaoProduto").value;
    if (descricao) {
      document.getElementById("motivo").focus();
    }
  }
});

document.getElementById("quantidade").addEventListener("input", verificarCampos);
document.getElementById("motivo").addEventListener("change", verificarCampos);

// Enter no motivo vai para quantidade
document.getElementById("motivo").addEventListener("keypress", (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById("quantidade").focus();
  }
});

// Enter na quantidade dispara salvar
document.getElementById("quantidade").addEventListener("keypress", (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    if (!document.getElementById("btnSalvar").disabled) {
      salvar();
    }
  }
});

function buscarProduto() {
  const codigoOriginal = document.getElementById("codigoProduto").value.trim();
  
  if (!codigoOriginal) {
    limparCamposProduto();
    return;
  }
  
  // Normaliza o c√≥digo digitado
  const codigoNormalizado = normalizarCodigo(codigoOriginal);
  
  showDebug(`Buscando: "${codigoOriginal}" (norm: "${codigoNormalizado}")`);
  
  // Busca no mapa - tenta v√°rias varia√ß√µes
  let produto = null;
  
  // 1. Tenta com c√≥digo normalizado
  produto = mapaBusca.get(codigoNormalizado);
  if (produto) {
    showDebug(`‚úì Encontrado com c√≥digo normalizado: "${codigoNormalizado}"`);
  }
  
  // 2. Tenta com c√≥digo original
  if (!produto) {
    produto = mapaBusca.get(codigoOriginal);
    if (produto) {
      showDebug(`‚úì Encontrado com c√≥digo original: "${codigoOriginal}"`);
    }
  }
  
  // 3. Busca case-insensitive em todas as chaves
  if (!produto) {
    const codigoLower = codigoOriginal.toLowerCase();
    for (const [chave, prod] of mapaBusca.entries()) {
      if (chave.toLowerCase() === codigoLower) {
        produto = prod;
        showDebug(`‚úì Encontrado com busca case-insensitive: "${chave}"`);
        break;
      }
    }
  }
  
  if (produto) {
    document.getElementById("descricaoProduto").value = produto.descricao;
    document.getElementById("embalagemProduto").value = produto.embalagem;
    document.getElementById("mensagemCodigo").innerText = "‚úÖ Produto encontrado!";
    document.getElementById("mensagemCodigo").style.color = "#28a745";
    
    showDebug(`Produto: ${produto.descricao}`);
  } else {
    limparCamposProduto();
    document.getElementById("mensagemCodigo").innerText = `‚ùå Produto n√£o encontrado (c√≥digo: ${codigoOriginal})`;
    document.getElementById("mensagemCodigo").style.color = "#dc3545";
    
    showDebug(`‚ùå N√ÉO encontrado`);
    
    // Debug: mostra c√≥digos similares
    if (debugMode && mapaBusca.size > 0) {
      const prefixo = codigoNormalizado.substring(0, Math.min(5, codigoNormalizado.length));
      const similares = [];
      
      for (const chave of mapaBusca.keys()) {
        if (chave.startsWith(prefixo)) {
          similares.push(chave);
          if (similares.length >= 3) break;
        }
      }
      
      if (similares.length > 0) {
        showDebug(`C√≥digos similares: ${similares.join(', ')}`);
      }
    }
  }
  
  verificarCampos();
}

function limparCamposProduto() {
  document.getElementById("descricaoProduto").value = "";
  document.getElementById("embalagemProduto").value = "";
}

function verificarCampos() {
  const codigoProduto = document.getElementById("codigoProduto").value.trim();
  const descricao = document.getElementById("descricaoProduto").value.trim();
  const motivo = document.getElementById("motivo").value.trim();
  const quantidade = document.getElementById("quantidade").value.trim();
  const quantidadeInt = parseInt(quantidade, 10);
  
  const camposOk = codigoProduto && 
                   descricao &&
                   motivo &&
                   !isNaN(quantidadeInt) && 
                   quantidadeInt >= 1 && 
                   quantidadeInt <= 9999;
  
  document.getElementById("btnSalvar").disabled = !camposOk;
}

async function salvar() {
  const codigoProduto = document.getElementById("codigoProduto").value.trim();
  const descricaoProduto = document.getElementById("descricaoProduto").value.trim();
  const embalagemProduto = document.getElementById("embalagemProduto").value.trim();
  const motivo = document.getElementById("motivo").value.trim();
  const quantidade = parseInt(document.getElementById("quantidade").value.trim(), 10);
  
  const btnSalvar = document.getElementById("btnSalvar");
  btnSalvar.disabled = true;
  btnSalvar.innerText = "Salvando...";
  
  try {
    const response = await fetch(`${API_BASE}/api/avaria`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'salvarRegistro',
        usuarioLogado: usuarioLogado,
        codigoProduto: codigoProduto,
        descricaoProduto: descricaoProduto,
        embalagemProduto: embalagemProduto,
        motivo: motivo,
        quantidade: quantidade
      })
    });
    
    const result = await response.json();
    
    document.getElementById("mensagem").innerText = result.msg;
    document.getElementById("mensagem").style.color = result.ok ? 'green' : 'red';
    
    if (result.ok) {
      limparCampos();
      setTimeout(() => {
        document.getElementById("codigoProduto").focus();
      }, 100);
    }
    
  } catch (error) {
    console.error('Erro ao salvar:', error);
    document.getElementById("mensagem").innerText = 'Erro ao salvar registro';
    document.getElementById("mensagem").style.color = 'red';
  } finally {
    btnSalvar.disabled = false;
    btnSalvar.innerText = "Salvar";
    verificarCampos();
  }
}

function limparCampos() {
  document.getElementById("codigoProduto").value = "";
  document.getElementById("descricaoProduto").value = "";
  document.getElementById("embalagemProduto").value = "";
  document.getElementById("motivo").value = "";
  document.getElementById("quantidade").value = "";
  document.getElementById("mensagemCodigo").innerText = "";
  document.getElementById("mensagem").innerText = "";
  
  document.getElementById("codigoProduto").focus();
}

window.onload = async () => {
  usuarioLogado = sessionStorage.getItem('usuario');
  
  if (!usuarioLogado) {
    alert('Sess√£o expirada');
    window.location.href = '/';
    return;
  }
  
  document.getElementById("userName").innerText = usuarioLogado;
  
  showDebug('Iniciando carregamento de produtos...');
  
  try {
    const resProdutos = await fetch(`${API_BASE}/api/avaria?action=obterDadosProdutos`);
    const resultProdutos = await resProdutos.json();
    
    if (resultProdutos.ok) {
      listaProdutos = resultProdutos.dados;
      
      // Reconstr√≥i Map a partir do objeto recebido
      mapaBusca = new Map(Object.entries(resultProdutos.mapaBusca || {}));
      
      showDebug(`‚úÖ ${listaProdutos.length} produtos carregados`);
      showDebug(`‚úÖ ${mapaBusca.size} c√≥digos indexados`);
      
      console.log(`[AVARIA] ‚úì Carregamento conclu√≠do`);
      console.log(`[AVARIA] - ${listaProdutos.length} produtos`);
      console.log(`[AVARIA] - ${mapaBusca.size} c√≥digos indexados`);
      
      atualizarStats();
      
      // Mostra exemplos se debug ativo
      if (debugMode && mapaBusca.size > 0) {
        const exemplos = Array.from(mapaBusca.entries()).slice(0, 3);
        showDebug('Exemplos de c√≥digos:');
        exemplos.forEach(([codigo, produto]) => {
          showDebug(`  "${codigo}" ‚Üí ${produto.descricao}`);
        });
      }
    } else {
      throw new Error('Erro ao carregar produtos');
    }
  } catch (error) {
    console.error('Erro ao carregar dados:', error);
    alert('Erro ao carregar dados. Verifique a conex√£o.');
    showDebug(`‚ùå Erro: ${error.message}`);
  }
  
  verificarCampos();
  document.getElementById("codigoProduto").focus();
};

// Atalho: Ctrl+D para modo debug
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 'd') {
    e.preventDefault();
    debugMode = !debugMode;
    document.getElementById('debugInfo').style.display = debugMode ? 'block' : 'none';
    showDebug(`Modo debug ${debugMode ? 'ATIVADO' : 'DESATIVADO'}`);
    if (!debugMode) {
      document.getElementById('debugInfo').innerHTML = '';
    } else {
      showDebug(`Total de produtos: ${listaProdutos.length}`);
      showDebug(`Total de c√≥digos: ${mapaBusca.size}`);
    }
  }
});
</script>
</body>
</html>
