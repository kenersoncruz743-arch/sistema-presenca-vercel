<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Produtividade Hora</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
.container{max-width:1800px;margin:0 auto}
.header{background:white;padding:20px 30px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1);margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
.header-left h1{color:#333;font-size:24px;display:flex;align-items:center;gap:10px}
.header-right{display:flex;gap:10px;flex-wrap:wrap}
.btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:#667eea;color:white}
.btn-success{background:#28a745;color:white}
.btn-danger{background:#dc3545;color:white}
.btn-warning{background:#ffc107;color:#212529}
.btn-secondary{background:#6c757d;color:white}
.btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.2)}
.btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
.alert{padding:15px 20px;border-radius:10px;margin-bottom:20px;display:flex;align-items:center;gap:10px;animation:slideIn 0.3s}
.alert-info{background:#d1ecf1;color:#0c5460;border-left:4px solid #17a2b8}
.alert-success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
.alert-danger{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
.alert-warning{background:#fff3cd;color:#856404;border-left:4px solid #ffc107}
@keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
.filters-panel{background:white;padding:20px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1);margin-bottom:20px}
.filters-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #e9ecef}
.filters-header h3{color:#333;font-size:18px;display:flex;align-items:center;gap:8px}
.filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}
.filter-group{display:flex;flex-direction:column;gap:5px}
.filter-group label{font-size:12px;font-weight:600;color:#555;text-transform:uppercase}
.filter-group input,.filter-group select{padding:8px 12px;border:2px solid #e0e0e0;border-radius:6px;font-size:14px}
.filter-actions{display:flex;gap:10px;flex-wrap:wrap}
.resumo-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
.stat-card{background:white;padding:20px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1);text-align:center}
.stat-card i{font-size:32px;color:#667eea;margin-bottom:10px}
.stat-card .value{font-size:28px;font-weight:bold;color:#333;margin-bottom:5px}
.stat-card .label{font-size:12px;color:#666;text-transform:uppercase;font-weight:600}
.table-container{background:white;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1);overflow:hidden;margin-bottom:20px}
.table-header{padding:20px;border-bottom:2px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
.table-header h2{color:#333;font-size:18px}
.table-wrapper{overflow-x:auto;max-height:600px}
table{width:100%;border-collapse:collapse}
thead{background:linear-gradient(135deg,#667eea,#764ba2);color:white;position:sticky;top:0;z-index:10}
th{padding:12px 8px;text-align:left;font-size:11px;font-weight:600;text-transform:uppercase;white-space:nowrap}
tbody tr{border-bottom:1px solid #f0f0f0;transition:background 0.2s}
tbody tr:hover{background:#f8f9ff}
td{padding:10px 8px;font-size:12px;color:#333;white-space:nowrap}
.loading{display:inline-block;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@media(max-width:768px){.header{flex-direction:column;text-align:center}}
</style>
</head>
<body>
<div class="container">
<div class="header">
<div class="header-left">
<h1><i class="fas fa-calculator"></i> Calculadora de Produtividade</h1>
</div>
<div class="header-right">
<button class="btn btn-success" onclick="calcularTudo()"><i class="fas fa-calculator"></i> Calcular</button>
<button class="btn btn-warning" onclick="location.reload()"><i class="fas fa-sync-alt"></i> Atualizar</button>
<button class="btn btn-secondary" onclick="window.location.href='/ferramentas'"><i class="fas fa-arrow-left"></i> Voltar</button>
</div>
</div>
<div class="filters-panel">
<div class="filters-header">
<h3><i class="fas fa-cogs"></i> Configurações</h3>
</div>
<div class="filters-grid">
<div class="filter-group">
<label><i class="fas fa-calendar-alt"></i> Data</label>
<input type="date" id="dataReferencia" value="">
</div>
<div class="filter-group">
<label><i class="fas fa-clock"></i> Horas Turno</label>
<input type="number" id="horasTrabalhadas" value="8" min="1" max="24" step="0.5">
</div>
</div>
<div class="filter-actions">
<button class="btn btn-primary" onclick="aplicarFiltros()"><i class="fas fa-filter"></i> Aplicar</button>
<button class="btn btn-secondary" onclick="limparFiltros()"><i class="fas fa-eraser"></i> Limpar</button>
</div>
</div>
<div id="statusDiv"></div>
<div id="loadingDiv" class="loading" style="text-align:center;padding:80px;color:white">
<i class="fas fa-spinner fa-spin" style="font-size:64px"></i>
<p style="margin-top:20px;font-size:18px">Carregando...</p>
</div>
<div id="contentDiv" style="display:none">
<div class="resumo-cards" id="resumoCards"></div>
<div class="table-container">
<div class="table-header">
<h2><i class="fas fa-table"></i> Análise por Função</h2>
</div>
<div class="table-wrapper">
<table id="tabelaProducao">
<thead>
<tr>
<th>Função</th>
<th>Turno</th>
<th>QL</th>
<th>Presente</th>
<th>Desvio</th>
<th>Afastado</th>
<th>Ausente</th>
<th>Férias/Folga</th>
<th>Deficit</th>
<th>Prod/Hora</th>
<th>Horas</th>
<th>Capacidade</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</div>
<script>
let dadosBase=[];
let dadosQLP=[];
let dadosProducao=[];
let dadosProdutividade={};
let funcoesPermitidas=[];
function showStatus(msg,type='info'){
const div=document.getElementById('statusDiv');
const icons={info:'info-circle',success:'check-circle',danger:'exclamation-triangle',warning:'exclamation-circle'};
div.innerHTML=`<div class="alert alert-${type}"><i class="fas fa-${icons[type]}"></i><span>${msg}</span></div>`;
setTimeout(()=>div.innerHTML='',5000);
}
async function carregarDados(){
try{
document.getElementById('loadingDiv').style.display='block';
document.getElementById('contentDiv').style.display='none';
let dataInput=document.getElementById('dataReferencia').value;
if(!dataInput){
const hoje=new Date();
const ano=hoje.getFullYear();
const mes=String(hoje.getMonth()+1).padStart(2,'0');
const dia=String(hoje.getDate()).padStart(2,'0');
dataInput=`${ano}-${mes}-${dia}`;
document.getElementById('dataReferencia').value=dataInput;
}
const resProdutividade=await fetch('/api/producao/dados?tipo=produtividade');
const resultProdutividade=await resProdutividade.json();
if(resultProdutividade.ok&&resultProdutividade.dados){
resultProdutividade.dados.forEach(p=>{
if(p.funcao&&p.produtividadeHora){
dadosProdutividade[p.funcao]=parseFloat(p.produtividadeHora)||0;
funcoesPermitidas.push(p.funcao);
}
});
}else{
throw new Error('Produtividade não encontrada');
}
let urlBase='/api/producao/resumo-base?modo=dados';
const dataRef=document.getElementById('dataReferencia').value;
if(dataRef){
urlBase+=`&data=${dataRef}`;
}
const resBase=await fetch(urlBase);
const resultBase=await resBase.json();
if(!resultBase.ok){
throw new Error(resultBase.msg||'Erro ao carregar Base');
}
dadosBase=resultBase.dados||[];
const resQLP=await fetch('/api/qlp/quadro');
const resultQLP=await resQLP.json();
if(!resultQLP.ok){
throw new Error('Erro ao carregar QLP');
}
dadosQLP=resultQLP.colaboradores||[];
processarDados();
calcularTudo();
renderTabela();
atualizarResumo();
document.getElementById('loadingDiv').style.display='none';
document.getElementById('contentDiv').style.display='block';
showStatus(`Dados carregados: ${dadosBase.length} registros`,'success');
}catch(error){
console.error('[PRODUCAO] Erro:',error);
document.getElementById('loadingDiv').innerHTML=`<i class="fas fa-exclamation-triangle" style="color:#dc3545;font-size:64px"></i><p style="margin-top:20px;color:#dc3545">Erro: ${error.message}</p><button class="btn btn-warning" onclick="location.reload()" style="margin-top:20px"><i class="fas fa-sync-alt"></i> Tentar Novamente</button>`;
showStatus(error.message,'error');
}
}
function processarDados(){
const qlpPorFuncaoTurno={};
dadosQLP.forEach(d=>{
if(!d.funcao||!d.isAtivo)return;
const funcao=d.funcao.trim();
const turno=(d.turno||'Sem Turno').trim();
if(!funcoesPermitidas.includes(funcao))return;
const chave=`${funcao}|${turno}`;
if(!qlpPorFuncaoTurno[chave]){
qlpPorFuncaoTurno[chave]={funcao:funcao,turno:turno,qlTotal:0};
}
qlpPorFuncaoTurno[chave].qlTotal++;
});
const basePorFuncaoTurno={};
dadosBase.forEach(d=>{
const funcao=(d.funcao||'Sem Função').trim();
const turno=(d.turno||'Sem Turno').trim();
const status=(d.status||'').trim();
if(!funcoesPermitidas.includes(funcao))return;
const chave=`${funcao}|${turno}`;
if(!basePorFuncaoTurno[chave]){
basePorFuncaoTurno[chave]={funcao:funcao,turno:turno,presente:0,desvio:0,ausente:0,atestado:0,ferias:0,folga:0,afastado:0};
}
const statusLower=status.toLowerCase();
if(statusLower==='presente')basePorFuncaoTurno[chave].presente++;
else if(statusLower==='desvio')basePorFuncaoTurno[chave].desvio++;
else if(statusLower==='ausente')basePorFuncaoTurno[chave].ausente++;
else if(statusLower==='atestado')basePorFuncaoTurno[chave].atestado++;
else if(statusLower.includes('férias')||statusLower.includes('ferias'))basePorFuncaoTurno[chave].ferias++;
else if(statusLower==='folga')basePorFuncaoTurno[chave].folga++;
else if(statusLower==='afastado')basePorFuncaoTurno[chave].afastado++;
});
dadosProducao=[];
Object.keys(basePorFuncaoTurno).forEach(chave=>{
const base=basePorFuncaoTurno[chave];
const qlp=qlpPorFuncaoTurno[chave]||{qlTotal:0};
dadosProducao.push({
funcao:base.funcao,
turno:base.turno,
qlTotal:qlp.qlTotal,
presente:base.presente,
desvio:base.desvio,
afastado:base.afastado,
ausente:base.ausente+base.atestado,
feriasFolga:base.ferias+base.folga,
produtividadeHora:dadosProdutividade[base.funcao]||0,
horasTurno:0,
capacidade:0,
deficit:0
});
});
dadosProducao.sort((a,b)=>{
if(a.funcao!==b.funcao)return a.funcao.localeCompare(b.funcao);
return a.turno.localeCompare(b.turno);
});
}
function renderTabela(){
const tbody=document.querySelector('#tabelaProducao tbody');
tbody.innerHTML='';
dadosProducao.forEach(d=>{
const tr=document.createElement('tr');
tr.innerHTML=`
<td><strong>${d.funcao}</strong></td>
<td><span style="background:#e3f2fd;padding:4px 8px;border-radius:4px;font-weight:600;color:#1976d2">${d.turno}</span></td>
<td style="background:#e3f2fd;text-align:center;font-weight:600">${d.qlTotal}</td>
<td style="background:#d4edda;text-align:center;font-weight:600">${d.presente}</td>
<td style="background:#fff3cd;text-align:center;font-weight:600">${d.desvio}</td>
<td style="background:#f8d7da;text-align:center;font-weight:600">${d.afastado}</td>
<td style="background:#f8d7da;text-align:center;font-weight:600">${d.ausente}</td>
<td style="background:#e3f2fd;text-align:center;font-weight:600">${d.feriasFolga}</td>
<td style="background:#fff3cd;text-align:center;font-weight:600">${d.deficit}</td>
<td style="background:#e1f5fe;text-align:center;font-weight:600">${d.produtividadeHora.toFixed(2)}</td>
<td style="background:#f3e5f5;text-align:center;font-weight:600">${d.horasTurno.toFixed(2)}</td>
<td style="background:#e8f5e9;text-align:center;font-weight:600;font-size:15px">${d.capacidade.toFixed(2)}</td>
`;
tbody.appendChild(tr);
});
}
function calcularLinha(idx){
const d=dadosProducao[idx];
d.produtividadeHora=dadosProdutividade[d.funcao]||0;
const dataRef=document.getElementById('dataReferencia').value;
const dataSelecionada=new Date(dataRef+'T12:00:00');
const diaSemana=dataSelecionada.getDay();
const ehSabado=diaSemana===6;
const turnoUpper=d.turno.toUpperCase();
if(turnoUpper.includes('TURNO A')||turnoUpper==='A'){
d.horasTurno=6.05;
}else if(turnoUpper.includes('TURNO B')||turnoUpper==='B'){
d.horasTurno=ehSabado?4:7.05;
}else if(turnoUpper.includes('TURNO C')||turnoUpper==='C'){
d.horasTurno=7.05;
}else{
d.horasTurno=8;
}
d.capacidade=d.presente*d.produtividadeHora*d.horasTurno;
d.deficit=d.desvio;
}
function calcularTudo(){
dadosProducao.forEach((d,idx)=>calcularLinha(idx));
renderTabela();
atualizarResumo();
showStatus('Cálculos atualizados!','success');
}
function atualizarResumo(){
const totalQL=dadosProducao.reduce((s,d)=>s+d.qlTotal,0);
const totalCapacidade=dadosProducao.reduce((s,d)=>s+d.capacidade,0);
const totalPresente=dadosProducao.reduce((s,d)=>s+d.presente,0);
const totalDesvio=dadosProducao.reduce((s,d)=>s+d.desvio,0);
const totalAfastado=dadosProducao.reduce((s,d)=>s+d.afastado,0);
const totalDeficit=dadosProducao.reduce((s,d)=>s+d.deficit,0);
document.getElementById('resumoCards').innerHTML=`
<div class="stat-card">
<i class="fas fa-users"></i>
<div class="value">${totalQL}</div>
<div class="label">QL Total</div>
</div>
<div class="stat-card">
<i class="fas fa-user-check" style="color:#28a745"></i>
<div class="value" style="color:#28a745">${totalPresente}</div>
<div class="label">Presente</div>
</div>
<div class="stat-card">
<i class="fas fa-exclamation-triangle" style="color:#dc3545"></i>
<div class="value" style="color:#dc3545">${totalDesvio}</div>
<div class="label">Desvio</div>
</div>
<div class="stat-card">
<i class="fas fa-minus-circle" style="color:#ffc107"></i>
<div class="value" style="color:#ffc107">${totalDeficit}</div>
<div class="label">Deficit</div>
</div>
<div class="stat-card">
<i class="fas fa-user-times" style="color:#6c757d"></i>
<div class="value" style="color:#6c757d">${totalAfastado}</div>
<div class="label">Afastado</div>
</div>
<div class="stat-card">
<i class="fas fa-chart-line" style="color:#17a2b8"></i>
<div class="value" style="color:#17a2b8">${totalCapacidade.toFixed(0)}</div>
<div class="label">Capacidade</div>
</div>
`;
}
function aplicarFiltros(){
carregarDados();
}
function limparFiltros(){
const hoje=new Date();
const ano=hoje.getFullYear();
const mes=String(hoje.getMonth()+1).padStart(2,'0');
const dia=String(hoje.getDate()).padStart(2,'0');
document.getElementById('dataReferencia').value=`${ano}-${mes}-${dia}`;
document.getElementById('horasTrabalhadas').value='8';
carregarDados();
}
document.addEventListener('DOMContentLoaded',function(){
const inputData=document.getElementById('dataReferencia');
if(inputData){
inputData.addEventListener('change',function(){
carregarDados();
});
}
});
window.onload=function(){
const usuario=sessionStorage.getItem('usuario');
if(!usuario){
showStatus('Sessão expirada','error');
setTimeout(()=>window.location.href='/',2000);
return;
}
carregarDados();
};
</script>
</body>
</html>
